<% define_template "movement", jsonmodel_definition(:movement) do |form| %>
  <div class="subrecord-form-fields">
      <%= form.label_and_textfield "user" %>
      <%= form.label_and_textfield "move_date" %>
      <%= form.label_and_select "functional_location", form.possible_options_for("functional_location", true) %>

      <% if form.obj['storage_location'] %>
        <% obj = form.obj['storage_location'] %>

        <% token = render_token :object => obj['_resolved'],
                                :label => obj['_resolved']['title'],
                                :type => "location",
                                :uri => obj["ref"],
                                :placement => "top" %>

        <%= form.label_with_field "storage_location", token %>
      <% end %>


    <% if form.readonly? %>
      <% if form.obj['move_context'] %>
        <% obj = form.obj['move_context'] %>

        <% token = render_token :object => obj['_resolved'],
                                :label => obj['_resolved']['title'],
                                :type => obj['_resolved']['jsonmodel_type'],
                                :uri => obj["ref"],
                                :placement => "top" %>

        <%= form.label_with_field "move_context", token %>
      <% end %>

    <% else %>
      <% form.push("move_context", form.obj["move_context"] || {}) do %>
        <div class="form-group">
          <%= form.label('move_context', {:for => 'move_context_linker'}, ['col-sm-2']) %>
          <div class="col-sm-9">
            <div class="form-group required">
              <div class="input-group linker-wrapper">
                <input type="text" class="linker"
                       id="move_context_linker"
                       data-label="Context"
                       data-label_plural="Context"
                       data-path="<%= form.path %>"
                       data-name="ref"
                       data-url="<%= url_for :controller => :search, :action => :do_search, :format => :json %>"
                       data-browse-url="<%= url_for :controller => :search, :action => :do_search, :format => :js, :facets => [], :display_identifier => true %>"
                       data-selected="<%= ASUtils.to_json(form.obj['_resolved'] || {}) %>"
                       data-format_property="display_string"
                       data-multiplicity="one"
                       data-types='["file_issue", "assessment"]'
                />
                <div class="input-group-btn">
                  <a class="btn btn-default dropdown-toggle last" data-toggle="dropdown" href="javascript:void(0);"><span class="caret"></span></a>
                  <ul class="dropdown-menu">
                    <li><a href="javascript:void(0);" class="linker-browse-btn"><%= I18n.t("actions.browse") %></a></li>
                  </ul>
                </div>
              </div>
            </div>
          </div>
        </div>
      <% end %>
    <% end %>





  </div>
<% end %>
