<% define_template "physical_representation", jsonmodel_definition(:physical_representation) do |form| %>
  <div class="subrecord-form-fields">

    <% if form.obj['deaccessioned'] %>
      <div class="row">
        <div class="col-sm-12">
          <div class="alert alert-info record-is-deaccessioned">
            <%= I18n.t('physical_representation.deaccessioned') %>
            <%= form.hidden_input "deaccessioned" %>
          </div>
        </div>
      </div>
    <% end %>

    <%= form.hidden_input "existing_ref" %>
    <%= render_aspace_partial :partial => 'shared/qsa_id_form', :locals => {:form => form, :model => :physical_representation} %>
    <%= form.label_and_textfield "title" %>
    <%= form.label_and_textarea "description" %>
    <%= form.label_and_textfield "agency_assigned_id" %>

    <% if form.readonly? %>
      <% if form['related_accession']  %>
        <div class="form-group">
          <div class="control-label col-sm-2"><%= I18n.t("physical_representation.related_accession") %></div>
          <div class="controls token-list col-sm-10">
            <% ASUtils.wrap(form['related_accession']).each do |record| %>
              <%= render_token :object => record['_resolved'],
                               :label => record['_resolved']['title'] || record['_resolved']['display_string'],
                               :type => record['_resolved']['jsonmodel_type'],
                               :uri => record['ref'],
                               :placement => "top" %>
            <% end %>
          </div>
        </div>
      <% end %>
    <% else %>
      <% form.push("related_accession", form.obj["related_accession"] || {}) do %>
        <div class="form-group">
          <%= form.label('related_accession', {:for => 'related_accession_linker'}, ['col-sm-2']) %>
          <div class="col-sm-9">
            <div class="form-group required">
              <div class="input-group linker-wrapper">
                <input type="text" class="linker"
                       id="accession_linker"
                       data-label="Accession"
                       data-label_plural="Accession"
                       data-path="<%= form.path %>"
                       data-name="ref"
                       data-url="<%= url_for :controller => :search, :action => :do_search, :format => :json %>"
                       data-browse-url="<%= url_for :controller => :search, :action => :do_search, :format => :js, :facets => [], :display_identifier => true %>"
                       data-selected="<%= ASUtils.to_json(form.obj['_resolved'] || {}) %>"
                       data-format_property="display_string"
                       data-multiplicity="one"
                       data-types='["accession"]'
                  />
                <div class="input-group-btn">
                  <a class="btn btn-default dropdown-toggle last" data-toggle="dropdown" href="javascript:void(0);"><span class="caret"></span></a>
                  <ul class="dropdown-menu">
                    <li><a href="javascript:void(0);" class="linker-browse-btn"><%= I18n.t("actions.browse") %></a></li>
                  </ul>
                </div>
              </div>
            </div>
          </div>
        </div>
      <% end %>
    <% end %>


    <%= form.label_and_select "access_category", form.possible_options_for("access_category", true) %>
    <%= form.hidden_input "current_location", "HOME" %>
    <%= form.label_and_readonly "current_location" %>
    <%= form.hidden_input "normal_location", "HOME" %>
    <%= form.label_and_select "accessioned_status", form.possible_options_for("accessioned_status", true) %>
    <%= form.label_and_select "colour", form.possible_options_for("colour", true) %>
    <%= form.label_and_select "contained_within", form.possible_options_for("contained_within", true) %>
    <%= form.label_and_textarea "exhibition_history" %>
    <%= form.label_and_textarea "exhibition_notes" %>
    <%= form.label_and_boolean "exhibition_quality" %>
    <%= form.label_and_boolean "file_issue_allowed", {}, true %>
    <%= form.label_and_select "format", form.possible_options_for("format", true) %>
    <%= form.label_and_select "intended_use", form.possible_options_for("intended_use", true) %>
    <%= form.label_and_textfield "original_registration_date" %>
    <%= form.label_and_textarea "other_restrictions_notes" %>
    <%= form.label_and_textarea "physical_format_details" %>
    <%= form.label_and_textarea "preferred_citation" %>
    <%= form.label_and_textarea "preservation_notes" %>
    <%= form.label_and_select "preservation_priority_rating", form.possible_options_for("preservation_priority_rating", true) %>
    <%= form.label_and_textarea "processing_handling_notes" %>
    <%= form.label_and_textarea "remarks" %>
    <%= form.label_and_select "salvage_priority_code", form.possible_options_for("salvage_priority_code", true) %>
    <%= form.label_and_boolean "sterilised_status" %>
    <%= form.label_and_boolean "publish" %>

    <%= form.label_and_date "approval_date" %>
    <% if form.readonly? %>
      <% if form['approved_by']  %>
        <div class="form-group">
          <div class="control-label col-sm-2"><%= I18n.t("physical_representation.approved_by") %></div>
          <div class="controls token-list col-sm-10">
            <% ASUtils.wrap(form['approved_by']).each do |record| %>
              <%= render_token :object => record['_resolved'],
                               :label => record['_resolved']['title'] || record['_resolved']['display_string'],
                               :type => record['_resolved']['jsonmodel_type'],
                               :uri => record['ref'],
                               :placement => "top" %>
            <% end %>
          </div>
        </div>
      <% end %>
    <% else %>
      <% form.push("approved_by", form.obj["approved_by"] || {}) do %>
        <div class="form-group">
          <%= form.label('approved_by', {:for => 'approved_by_linker'}, ['col-sm-2']) %>
          <div class="col-sm-9">
            <div class="form-group required">
              <div class="input-group linker-wrapper">
                <input type="text" class="linker"
                       id="approved_by_linker"
                       data-label="<%= I18n.t("physical_representation.approved_by") %>"
                       data-label_plural="<%= I18n.t("physical_representation.approved_by") %>"
                       data-path="<%= form.path %>"
                       data-name="ref"
                       data-url="<%= url_for :controller => :search, :action => :do_search, :format => :json %>"
                       data-browse-url="<%= url_for :controller => :search, :action => :do_search, :format => :js, :facets => [], :display_identifier => true %>"
                       data-selected="<%= ASUtils.to_json(form.obj['_resolved'] || {}) %>"
                       data-format_property="display_string"
                       data-multiplicity="one"
                       data-types='["agent_with_user"]'
                  />
                <div class="input-group-btn">
                  <a class="btn btn-default dropdown-toggle last" data-toggle="dropdown" href="javascript:void(0);"><span class="caret"></span></a>
                  <ul class="dropdown-menu">
                    <li><a href="javascript:void(0);" class="linker-browse-btn"><%= I18n.t("actions.browse") %></a></li>
                  </ul>
                </div>
              </div>
            </div>
          </div>
        </div>
      <% end %>
    <% end %>


    <div class="subrecord-form-container">
      <% if form.readonly? %>
        <% if form['container']  %>
          <div class="form-group">
            <div class="control-label col-sm-2"><%= I18n.t("top_container._singular") %></div>
            <div class="controls token-list col-sm-10">
              <% ASUtils.wrap(form['container']).each do |record| %>
                <%= render_token :object => record['_resolved'],
                 :label => record['_resolved']['title'] || record['_resolved']['display_string'],
                 :type => record['_resolved']['jsonmodel_type'],
                 :uri => record['ref'],
                 :placement => "top" %>
              <% end %>
            </div>
          </div>
        <% end %>
      <% else %>
        <% is_container_required  = !form.obj['deaccessioned'] %>
        <% form.push("container", form.obj["container"] || {}) do %>
          <%= render_aspace_partial :partial => "top_containers/linker", :locals => {:form => form, :label => I18n.t("top_container._singular"), :required => is_container_required} %>
        <% end %>
      <% end %>
      <% unless form.readonly? && ASUtils.wrap(form.obj['extents']).empty? %>
        <%= render_aspace_partial :partial => "shared/subrecord_form", :locals => {:form => form, :name => "extents"} %>
      <% end %>
      <% unless form.readonly? && ASUtils.wrap(form.obj['deaccessions']).empty? %>
        <%= render_aspace_partial :partial => "shared/subrecord_form", :locals => {:form => form, :name => "deaccessions"} %>
      <% end %>

      <% if form.readonly? %>
        <%= show_plugins_for(JSONModel(:physical_representation).from_hash(form.obj, :trusted), form) %>
      <% else %>
        <%= form_plugins_for("physical_representation", form, JSONModel(:physical_representation).new._always_valid!) %>
      <% end %>
    </div>
  </div>
<% end %>
